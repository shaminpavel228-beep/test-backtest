// Built from parts in pine/src/parts

// --- 01_preamble.pine ---
//@version=5
strategy("üéõÔ∏è –ë–ï–ö–¢–ï–°–¢ –î–õ–Ø –°–¢–†–ê–¢–ï–ì–ò–ô v3.7 [strategy]", overlay=true, max_labels_count=500, max_lines_count=500, max_bars_back=5000, default_qty_type=strategy.fixed, default_qty_value=0, initial_capital=1000)



// --- 02_–ì–†–£–ü–ü–ê_1_–ù–ê–°–¢–†–û–ô–ö–ò_–ò_–û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï_–î–ê–®–ë–û–†–î–ê.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 1: –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê


// --- 03_section_3.pine ---
// ============================================
showDashboard = input.bool(true, "‚úÖ –ü–æ–∫–∞–∑–∞—Ç—å –î–∞—à–±–æ—Ä–¥", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
dashboardPosition = input.string("Top Right", "üìç –ü–æ–∑–∏—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞", options=["Top Left", "Top Center", "Top Right", "Bottom Left", "Bottom Center", "Bottom Right"], group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
botMode = input.string("–û–±–∞", "üéØ –†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏", options=["–û–±–∞", "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥", "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç"], group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")

// –ù–ê–°–¢–†–û–ô–ö–ò –í–†–ï–ú–ï–ù–ù–û–ì–û –ü–ï–†–ò–û–î–ê
showTimePeriod = input.bool(true, "‚è≥ –í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
useCustomStartDate = input.bool(true, "üìÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
startDate = input.time(timestamp("2024-08-05T00:00:00"), "üìÜ –ù–∞—á–∞–ª–æ —Ç–æ—Ä–≥–æ–≤–ª–∏", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê", tooltip="–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞")
useRealTimeEnd = input.bool(true, "üîÑ –î–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê", tooltip="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ - –±—ç–∫—Ç–µ—Å—Ç –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞")
endDate = input.time(timestamp("2026-01-18T00:00:00"), "üìÜ –ö–æ–Ω–µ—Ü —Ç–æ—Ä–≥–æ–≤–ª–∏", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê", tooltip="–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ '–î–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏' –≤—ã–∫–ª—é—á–µ–Ω–æ")

// –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Å–µ–∫—Ü–∏–π –¥–∞—à–±–æ—Ä–¥–∞ - –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ü–û–†–Ø–î–û–ö –ù–ê–°–¢–†–û–ï–ö
showCapitalSection = input.bool(true, "üí∞ –ö–∞–ø–∏—Ç–∞–ª", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showRiskSection = input.bool(true, "üìä –†–∏—Å–∫", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showStatusSection = input.bool(true, "‚ö° –°—Ç–∞—Ç—É—Å", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showSettingsSection = input.bool(true, "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showIndicatorsSection = input.bool(true, "üìä –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showPositionSection = input.bool(true, "üìà –ü–æ–∑–∏—Ü–∏—è", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showStatisticsSection = input.bool(true, "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showProfitSection = input.bool(true, "üí∞ –ü—Ä–∏–±—ã–ª—å", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showSignalsSection = input.bool(true, "üéØ –°–∏–≥–Ω–∞–ª—ã", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")
showCurrentSignalSection = input.bool(true, "üéØ –¢–µ–∫—É—â–∏–π —Å–∏–≥–Ω–∞–ª", group="üëÅÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê")



// --- 04_–ì–†–£–ü–ü–ê_2_–£–ü–†–ê–í–õ–ï–ù–ò–ï_–†–ò–°–ö–û–ú.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 2: –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú


// --- 05_section_5.pine ---
// ============================================
initialDeposit = input.float(1000, "üí∞ –ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç ($)", minval=100, maxval=100000, step=100, group="üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")
commission = input.float(0.1, "üí≥ –ö–æ–º–∏—Å—Å–∏—è (%)", minval=0.01, maxval=1, step=0.01, group="üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")
marginType = input.string("–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "üè¶ –¢–∏–ø –º–∞—Ä–∂–∏", options=["–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–ö—Ä–æ—Å—Å"], group="üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")
leverage = input.int(10, "‚öñÔ∏è –ü–ª–µ—á–æ (1-100)", minval=1, maxval=100, group="üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")
riskPerTrade = input.float(2.0, "üéØ % –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–∞ —Å–¥–µ–ª–∫—É", minval=0.1, maxval=10, step=0.1, group="üìä –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")



// --- 06_–ì–†–£–ü–ü–ê_3_–ù–ê–°–¢–†–û–ô–ö–ò_–û–†–î–ï–†–û–í_-_–¢–ï–ô–ö-–ü–†–û–§–ò–¢.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 3: –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í - –¢–ï–ô–ö-–ü–†–û–§–ò–¢


// --- 07_section_7.pine ---
// ============================================
useTP = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")
tpPercent = input.float(1.5, "–¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç %", minval=0.1, maxval=20, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")



// --- 08_–ì–†–£–ü–ü–ê_4_–ù–ê–°–¢–†–û–ô–ö–ò_–û–†–î–ï–†–û–í_-_–°–¢–û–ü-–õ–û–°–°.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 4: –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í - –°–¢–û–ü-–õ–û–°–°


// --- 09_section_9.pine ---
// ============================================
useSL = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å –°—Ç–æ–ø-–õ–æ—Å—Å", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")
slPercent = input.float(1.0, "–°—Ç–æ–ø-–õ–æ—Å—Å %", minval=0.1, maxval=20, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")



// --- 10_–ì–†–£–ü–ü–ê_5_–ù–ê–°–¢–†–û–ô–ö–ò_–£–°–†–ï–î–ù–ï–ù–ò–Ø.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 5: –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø


// --- 11_section_11.pine ---
// ============================================
useAveraging = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ", group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
maxAvgCount = input.int(5, "–ú–∞–∫—Å. —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π (1-10)", minval=1, maxval=10, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
martingaleMultiplier = input.float(2.0, "–ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—ä–µ–º–∞", minval=1.0, maxval=3.0, step=0.1, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
avgDistancePercent = input.float(0.5, "–î–∏—Å—Ç–∞–Ω—Ü–∏—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è %", minval=0.1, maxval=5.0, step=0.1, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")



// --- 12_–ì–†–£–ü–ü–ê_6_–ù–ê–°–¢–†–û–ô–ö–ò_–ò–ù–î–ò–ö–ê–¢–û–†–û–í_-_RSI.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 6: –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í - RSI


// --- 13_section_13.pine ---
// ============================================
useRSI = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å RSI", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiLength = input.int(14, "–ü–µ—Ä–∏–æ–¥ RSI (7-30)", minval=7, maxval=30, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiLongLevel = input.int(30, "–£—Ä–æ–≤–µ–Ω—å –ø–æ–∫—É–ø–∫–∏ RSI", minval=1, maxval=50, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiShortLevel = input.int(70, "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–¥–∞–∂–∏ RSI", minval=50, maxval=99, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")



// --- 14_–ì–†–£–ü–ü–ê_7_–ù–ê–°–¢–†–û–ô–ö–ò_–ò–ù–î–ò–ö–ê–¢–û–†–û–í_-_BOLLINGER_BANDS.pine ---
// ============================================
// –ì–†–£–ü–ü–ê 7: –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í - BOLLINGER BANDS


// --- 15_section_15.pine ---
// ============================================
useBB = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å Bollinger Bands", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
bbLength = input.int(20, "–ü–µ—Ä–∏–æ–¥ BB (10-50)", minval=10, maxval=50, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
bbStdDev = input.float(2.0, "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ", minval=1.5, maxval=3.0, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")



// --- 16_–§–£–ù–ö–¶–ò–ò_–î–õ–Ø_–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø_–î–ê–¢–´.pine ---
// ============================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–¢–´


// --- 17_section_17.pine ---
// ============================================
formatDate(timestamp) =>
    y = year(timestamp)
    m = month(timestamp)
    d = dayofmonth(timestamp)
    monthStr = m < 10 ? "0" + str.tostring(m) : str.tostring(m)
    dayStr = d < 10 ? "0" + str.tostring(d) : str.tostring(d)
    str.tostring(y) + "." + monthStr + "." + dayStr

getCurrentDate() =>
    formatDate(time)

getEndDateString() =>
    if useRealTimeEnd
        "–ò–î–ï–¢ –¢–û–†–ì–û–í–õ–Ø"
    else
        formatDate(endDate)

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å–≤–µ—á–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
isInTimePeriod() =>
    inPeriod = true

    if useCustomStartDate
        inPeriod := inPeriod and (time >= startDate)

    if not useRealTimeEnd
        inPeriod := inPeriod and (time <= endDate)

    inPeriod



// --- 18_–†–ê–°–ß–ï–¢_–ò–ù–î–ò–ö–ê–¢–û–†–û–í.pine ---
// ============================================
// –†–ê–°–ß–ï–¢ –ò–ù–î–ò–ö–ê–¢–û–†–û–í


// --- 19_section_19.pine ---
// ============================================
rsi = ta.rsi(close, rsiLength)
bbBasis = ta.sma(close, bbLength)
bbDev = bbStdDev * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev



// --- 20_–°–ò–ì–ù–ê–õ–´_–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø_–õ–û–ì–ò–ö–ê.pine ---
// ============================================
// –°–ò–ì–ù–ê–õ–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê)


// --- 21_–°–∏–≥–Ω–∞–ª—ã_—Ä–∞–±–æ—Ç–∞—é—Ç_–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ_–¥–ª—è_–∫–∞–∂–¥–æ–≥–æ_–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞.pine ---
// ============================================
// –°–∏–≥–Ω–∞–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
rsiLongSignal = useRSI and rsi <= rsiLongLevel
rsiShortSignal = useRSI and rsi >= rsiShortLevel
bbLongSignal = useBB and close <= bbLower
bbShortSignal = useBB and close >= bbUpper

// –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (—Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
finalLongSignal = false
finalShortSignal = false

if useRSI and useBB
// –ï—Å–ª–∏ –æ–±–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω—ã - –Ω—É–∂–Ω—ã —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –æ–±–æ–∏—Ö
finalLongSignal := rsiLongSignal and bbLongSignal
finalShortSignal := rsiShortSignal and bbShortSignal
else if useRSI
// –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç–æ–ª—å–∫–æ RSI
finalLongSignal := rsiLongSignal
finalShortSignal := rsiShortSignal
else if useBB
// –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç–æ–ª—å–∫–æ BB
finalLongSignal := bbLongSignal
finalShortSignal := bbShortSignal

// –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ (—Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
showLongSignal = rsiLongSignal or bbLongSignal
showShortSignal = rsiShortSignal or bbShortSignal



// --- 22_–ì–õ–û–ë–ê–õ–¨–ù–´–ï_–ü–ï–†–ï–ú–ï–ù–ù–´–ï.pine ---
// ============================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï


// --- 23_section_23.pine ---
// ============================================
var float currentBalance = initialDeposit
var float maxBalance = initialDeposit
var float maxDrawdownValue = 0.0
var bool tradingEnabled = true
var bool botStopped = false

var float longEntryPrice = na
var float shortEntryPrice = na
var int longAvgCount = 0
var int shortAvgCount = 0
var float longTotalVolume = 0.0
var float shortTotalVolume = 0.0
var bool longPositionActive = false
var bool shortPositionActive = false
var bool anyPositionActive = false

var int totalWins = 0
var int totalLosses = 0
var float totalProfit = 0.0
var float totalCommission = 0.0

var array<float> longAvgPrices = array.new<float>(10, na)
var array<float> shortAvgPrices = array.new<float>(10, na)
var array<float> longAvgVolumes = array.new<float>(10, 0.0)
var array<float> shortAvgVolumes = array.new<float>(10, 0.0)

var float longStopLossPrice = na
var float longTakeProfitPrice = na
var float shortStopLossPrice = na
var float shortTakeProfitPrice = na



// --- 24_–í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï_–§–£–ù–ö–¶–ò–ò.pine ---
// ============================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò


// --- 25_section_25.pine ---
// ============================================

calculateAveragePrice(prices, volumes) =>
totalValue = 0.0
totalVol = 0.0
for i = 0 to array.size(prices) - 1
price = array.get(prices, i)
vol = array.get(volumes, i)
if not na(price)
totalValue := totalValue + price * vol
totalVol := totalVol + vol
totalVol > 0 ? totalValue / totalVol : na

// –£–ü–†–û–©–ï–ù–ù–´–ô –†–ê–°–ß–ï–¢ –û–ë–™–ï–ú–ê (—Ç–æ–ª—å–∫–æ % –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞)
calculatePositionVolume(entryPrice) =>
// –ü—Ä–æ—Å—Ç–æ % –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
posVol = (currentBalance * (riskPerTrade / 100)) / entryPrice

// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –æ–±—ä–µ–º–æ–º –ø–æ –ø–ª–µ—á—É
maxVol = (currentBalance * leverage) / entryPrice
posVol := math.min(posVol, maxVol)
posVol

// –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä volume -> tradeVol
calculateCommission(tradeVol, price) =>
(tradeVol * price) * (commission / 100)

calculateLiquidationPrice(entryPrice, isLong) =>
if marginType == "–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è"
if isLong
entryPrice * (1 - (1 / leverage) * 0.9)
else
entryPrice * (1 + (1 / leverage) * 0.9)
else
if isLong
entryPrice * (1 - (1 / leverage) * 0.8)
else
entryPrice * (1 + (1 / leverage) * 0.8)

checkSufficientFunds(tradeVol, price) =>
requiredMargin = (tradeVol * price) / leverage
freeMargin = currentBalance - (longTotalVolume * (longPositionActive ? longEntryPrice : 0) + shortTotalVolume * (shortPositionActive ? shortEntryPrice : 0)) / leverage
requiredMargin <= freeMargin

// –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –ø–∞—Ä–∞–º–µ—Ç—Ä volume -> tradeVol
calculatePnL(entryPrice, exitPrice, tradeVol, isLong) =>
float profit = 0.0
if isLong
profit := (exitPrice - entryPrice) * tradeVol
else
profit := (entryPrice - exitPrice) * tradeVol

// –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
commissionFee = calculateCommission(tradeVol, exitPrice)
profit - commissionFee



// --- 26_–û–¢–†–ò–°–û–í–ö–ê_–î–ê–®–ë–û–†–î–ê_–ù–û–í–´–ô_–ü–û–†–Ø–î–û–ö_–û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø.pine ---
// ============================================
// –û–¢–†–ò–°–û–í–ö–ê –î–ê–®–ë–û–†–î–ê (–ù–û–í–´–ô –ü–û–†–Ø–î–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø)


// --- 27_section_27.pine ---
// ============================================
drawDashboard() =>
if barstate.islast and showDashboard
tablePos = switch dashboardPosition
"Top Left" => position.top_left
"Top Center" => position.top_center
"Top Right" => position.top_right
"Bottom Left" => position.bottom_left
"Bottom Center" => position.bottom_center
"Bottom Right" => position.bottom_right
=> position.top_right

// –§–ò–ö–°–ò–†–£–ï–ú 3 –ö–û–õ–û–ù–ö–ò (—É–±—Ä–∞–ª–∏ dashboardColumns)
dash = table.new(tablePos, 3, 45, bgcolor = color.new(#000000, 80), border_color = color.new(#555555, 50))
row = 0

// –ó–ê–ì–û–õ–û–í–û–ö (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
table.cell(dash, 0, row, "üéõÔ∏è –ë–ï–ö–¢–ï–°–¢ –î–õ–Ø –°–¢–†–ê–¢–ï–ì–ò–ô", bgcolor = color.new(#4A148C, 90), text_color = color.white, text_size = size.normal)
table.cell(dash, 1, row, "–í–µ—Ä—Å–∏—è 3.7", bgcolor = color.new(#4A148C, 90), text_color = color.yellow, text_size = size.small)
table.cell(dash, 2, row, timeframe.period, bgcolor = color.new(#4A148C, 90), text_color = color.white, text_size = size.small)

row := row + 1

// 1. ‚ö° –°–¢–ê–¢–£–°
if showStatusSection
table.cell(dash, 0, row, "‚ö° –°–¢–ê–¢–£–°", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "–ë–æ—Ç:", text_color = color.gray)
statusText = botStopped ? "–û–°–¢–ê–ù–û–í–õ–ï–ù" : tradingEnabled ? "–ê–ö–¢–ò–í–ï–ù" : "–ü–ê–£–ó–ê"
statusColor = botStopped ? color.red : tradingEnabled ? color.green : color.orange
table.cell(dash, 2, row, statusText, text_color = statusColor)

row := row + 1

// 2. ‚è≥ –í–†–ï–ú–ï–ù–ù–û–ô –ü–ï–†–ò–û–î
if showTimePeriod
table.cell(dash, 0, row, "‚è≥ –í–†–ï–ú–ï–ù–ù–û–ô –ü–ï–†–ò–û–î", bgcolor = color.new(#1A237E, 70), text_color = color.white)

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏
localStartDateStr = useCustomStartDate ? formatDate(startDate) : "–ù–ê–ß–ê–õ–û –ì–†–ê–§–ò–ö–ê"
localEndDateStr = useRealTimeEnd ? "–ò–î–ï–¢ –¢–û–†–ì–û–í–õ–Ø" : formatDate(endDate)

table.cell(dash, 1, row, localStartDateStr + " -", text_color = color.gray)
table.cell(dash, 2, row, localEndDateStr, text_color = color.white)

row := row + 1

// 3. ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò
if showSettingsSection
table.cell(dash, 0, row, "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "–†–µ–∂–∏–º:", text_color = color.gray)
botColor = botMode == "–û–±–∞" ? color.orange : botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥" ? color.green : color.red
table.cell(dash, 2, row, botMode, text_color = botColor)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–ú–∞—Ä–∂–∞:", text_color = color.gray)
table.cell(dash, 2, row, marginType, text_color = color.blue)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–ü–ª–µ—á–æ:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(leverage) + "x", text_color = color.yellow)

row := row + 1

// 4. üìä –†–ò–°–ö
if showRiskSection
table.cell(dash, 0, row, "üìä –†–ò–°–ö", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(riskPerTrade, "#.#") + "%", text_color = color.yellow)

row := row + 1

// 5. üí∞ –ö–ê–ü–ò–¢–ê–õ
if showCapitalSection
table.cell(dash, 0, row, "üí∞ –ö–ê–ü–ò–¢–ê–õ", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "–ù–∞—á–∞–ª—å–Ω—ã–π:", text_color = color.gray)
table.cell(dash, 2, row, "$" + str.tostring(initialDeposit, "#.##"), text_color = color.white)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–¢–µ–∫—É—â–∏–π:", text_color = color.gray)
balanceColor = currentBalance >= initialDeposit ? color.green : color.red
table.cell(dash, 2, row, "$" + str.tostring(currentBalance, "#.##"), text_color = balanceColor)

row := row + 1

profitPercent = ((currentBalance - initialDeposit) / initialDeposit) * 100
table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–ü—Ä–∏–±—ã–ª—å:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(profitPercent, "#.##") + "%", text_color = profitPercent >= 0 ? color.green : color.red)

row := row + 1

// 6. üí∞ –ü–†–ò–ë–´–õ–¨
if showProfitSection
table.cell(dash, 0, row, "üí∞ –ü–†–ò–ë–´–õ–¨", bgcolor = color.new(#4A148C, 80), text_color = color.white)
table.cell(dash, 1, row, "–í—Å–µ–≥–æ:", text_color = color.gray)
table.cell(dash, 2, row, "$" + str.tostring(totalProfit, "#.##"), text_color = totalProfit >= 0 ? color.green : color.red)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–ö–æ–º–∏—Å—Å–∏–∏:", text_color = color.gray)
table.cell(dash, 2, row, "$" + str.tostring(totalCommission, "#.##"), text_color = color.orange)

row := row + 1

// 7. üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê
if showStatisticsSection
table.cell(dash, 0, row, "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "–ü–æ–±–µ–¥:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(totalWins), text_color = color.green)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–ü–æ—Ä–∞–∂–µ–Ω–∏–π:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(totalLosses), text_color = color.red)

row := row + 1

winRate = totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0
table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–í–∏–Ω—Ä–µ–π—Ç:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(winRate, "#.##") + "%", text_color = winRate >= 50 ? color.green : color.red)

row := row + 1

// 8. üìä –ò–ù–î–ò–ö–ê–¢–û–†–´
if showIndicatorsSection
table.cell(dash, 0, row, "üìä –ò–ù–î–ò–ö–ê–¢–û–†–´", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "RSI:", text_color = color.gray)
rsiColor = rsi <= 30 ? color.green : rsi >= 70 ? color.red : color.white
table.cell(dash, 2, row, str.tostring(rsi, "#.##"), text_color = rsiColor)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "BB:", text_color = color.gray)
bbPos = close <= bbLower ? "–ù–ò–ó" : close >= bbUpper ? "–í–ï–†–•" : "–°–†–ï–î"
bbPosColor = close <= bbLower ? color.green : close >= bbUpper ? color.red : color.gray
table.cell(dash, 2, row, bbPos, text_color = bbPosColor)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "–¶–µ–Ω–∞:", text_color = color.gray)
table.cell(dash, 2, row, str.tostring(close, "#.#####"), text_color = color.white)

row := row + 1

// 9. üéØ –°–ò–ì–ù–ê–õ–´
if showSignalsSection
table.cell(dash, 0, row, "üéØ –°–ò–ì–ù–ê–õ–´", bgcolor = color.new(#1A237E, 70), text_color = color.white)
table.cell(dash, 1, row, "RSI:", text_color = color.gray)
rsiSignal = rsiLongSignal or rsiShortSignal
table.cell(dash, 2, row, rsiSignal ? "–î–ê" : "–ù–ï–¢", text_color = rsiSignal ? color.green : color.red)

row := row + 1

table.cell(dash, 0, row, "", text_color = color.gray)
table.cell(dash, 1, row, "BB:", text_color = color.gray)
bbSignal = bbLongSignal or bbShortSignal
table.cell(dash, 2, row, bbSignal ? "–î–ê" : "–ù–ï–¢", text_color = bbSignal ? color.green : color.red)

row := row + 1

// 10. üìà –ü–û–ó–ò–¶–ò–Ø
if showPositionSection
table.cell(dash, 0, row, "üìà –ü–û–ó–ò–¶–ò–Ø", bgcolor = color.new(#1A237E, 70), text_color = color.white)
if longPositionActive
table.cell(dash, 1, row, "–õ–û–ù–ì", bgcolor = color.new(#1B5E20, 70), text_color = color.white)
else if shortPositionActive
table.cell(dash, 1, row, "–®–û–†–¢", bgcolor = color.new(#B71C1C, 70), text_color = color.white)
else
table.cell(dash, 1, row, "–ù–ï–¢", bgcolor = color.new(#424242, 70), text_color = color.white)

if longPositionActive or shortPositionActive
table.cell(dash, 2, row, "–ê–ö–¢–ò–í–ù–ê", text_color = color.green)
else
table.cell(dash, 2, row, "–û–ñ–ò–î–ê–ù–ò–ï", text_color = color.gray)

row := row + 1

if longPositionActive
avgPriceLong = calculateAveragePrice(longAvgPrices, longAvgVolumes)
table.cell(dash, 0, row, "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:", text_color = color.gray)
table.cell(dash, 1, row, str.tostring(avgPriceLong, "#.#####"), text_color = color.green)
currentPLLong = not na(avgPriceLong) ? ((close - avgPriceLong) / avgPriceLong) * 100 : 0
table.cell(dash, 2, row, str.tostring(currentPLLong, "#.##") + "%", text_color = currentPLLong >= 0 ? color.green : color.red)

row := row + 1

// –£—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –¥–ª—è –ª–æ–Ω–≥–∞
if useAveraging and longAvgCount > 0
table.cell(dash, 0, row, "–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–π:", text_color = color.gray)
table.cell(dash, 1, row, str.tostring(longAvgCount), text_color = longAvgCount > 0 ? color.orange : color.gray)
table.cell(dash, 2, row, "", text_color = color.gray)

row := row + 1

else if shortPositionActive
avgPriceShort = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
table.cell(dash, 0, row, "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:", text_color = color.gray)
table.cell(dash, 1, row, str.tostring(avgPriceShort, "#.#####"), text_color = color.red)
currentPLShort = not na(avgPriceShort) ? ((avgPriceShort - close) / avgPriceShort) * 100 : 0
table.cell(dash, 2, row, str.tostring(currentPLShort, "#.##") + "%", text_color = currentPLShort >= 0 ? color.green : color.red)

row := row + 1

// –£—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –¥–ª—è —à–æ—Ä—Ç–∞
if useAveraging and shortAvgCount > 0
table.cell(dash, 0, row, "–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–π:", text_color = color.gray)
table.cell(dash, 1, row, str.tostring(shortAvgCount), text_color = shortAvgCount > 0 ? color.orange : color.gray)
table.cell(dash, 2, row, "", text_color = color.gray)

row := row + 1

else
table.cell(dash, 0, row, "–°—Ç–∞—Ç—É—Å:", text_color = color.gray)
table.cell(dash, 1, row, "–û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞", text_color = color.white)
table.cell(dash, 2, row, "", text_color = color.gray)

row := row + 1

// 11. üéØ –¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ
if showCurrentSignalSection
canTrade = tradingEnabled and not anyPositionActive and not botStopped

signalBg = color.new(#424242, 80)
if canTrade and finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
signalBg := color.new(#1B5E20, 80)
else if canTrade and finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
signalBg := color.new(#B71C1C, 80)

table.cell(dash, 0, row, "üéØ –¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–ª", bgcolor = signalBg, text_color = color.white)
signalText = ""
if botStopped
signalText := "–ë–û–¢ –û–°–¢–ê–ù–û–í–õ–ï–ù"
else if tradingEnabled == false
signalText := "–¢–û–†–ì–û–í–õ–Ø –ü–†–ò–û–°–¢–ê–ù–û–í–õ–ï–ù–ê"
else if anyPositionActive
signalText := "–ü–û–ó–ò–¶–ò–Ø –û–¢–ö–†–´–¢–ê"
else if finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
signalText := "–õ–û–ù–ì üü¢"
else if finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
signalText := "–®–û–†–¢ üî¥"
else
signalText := "–û–ñ–ò–î–ê–ù–ò–ï ‚ö™"

signalColor = color.gray
if signalText == "–õ–û–ù–ì üü¢"
signalColor := color.green
else if signalText == "–®–û–†–¢ üî¥"
signalColor := color.red

table.cell(dash, 1, row, signalText, text_color = signalColor, text_size = size.normal)

row := row + 1



// --- 28_–û–°–ù–û–í–ù–ê–Ø_–¢–û–†–ì–û–í–ê–Ø_–õ–û–ì–ò–ö–ê.pine ---
// ============================================
// –û–°–ù–û–í–ù–ê–Ø –¢–û–†–ì–û–í–ê–Ø –õ–û–ì–ò–ö–ê


// --- 29_section_29.pine ---
// ============================================
if barstate.isconfirmed and not botStopped and isInTimePeriod()
// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
anyPositionActive := longPositionActive or shortPositionActive

// –û–ë–ù–û–í–õ–Ø–ï–ú –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ë–ê–õ–ê–ù–° –ò –ü–†–û–°–ê–î–ö–£
if currentBalance > maxBalance
maxBalance := currentBalance

drawdown = ((maxBalance - currentBalance) / maxBalance) * 100
maxDrawdownValue := math.max(maxDrawdownValue, drawdown)

// –õ–û–ì–ò–ö–ê –û–¢–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô (–£–ü–†–û–©–ï–ù–ù–´–ô –†–ê–°–ß–ï–¢ –û–ë–™–ï–ú–ê)
if tradingEnabled and not anyPositionActive
// –ü–†–û–í–ï–†–ö–ê –°–ò–ì–ù–ê–õ–ê –ù–ê –õ–û–ù–ì
if finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–º (% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞)
posVol = calculatePositionVolume(close)

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
if posVol > 0 and checkSufficientFunds(posVol, close)
// –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ü–û –†–´–ù–ö–£ (–º–∞—Ä–∫–µ—Ç)
longEntryPrice := close
longPositionActive := true
longAvgCount := 0
longTotalVolume := posVol
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–¥–µ–ª–∫–∏
strategy.entry("LONG", strategy.long, qty=posVol)

// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –ü–û–°–õ–ï –æ—Ç–∫—Ä—ã—Ç–∏—è
longStopLossPrice := useSL ? close * (1 - slPercent / 100) : na
longTakeProfitPrice := useTP ? close * (1 + tpPercent / 100) : na

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
array.fill(longAvgPrices, na)
array.fill(longAvgVolumes, 0.0)
array.set(longAvgPrices, 0, longEntryPrice)
array.set(longAvgVolumes, 0, posVol)

// –ü–†–û–í–ï–†–ö–ê –°–ò–ì–ù–ê–õ–ê –ù–ê –®–û–†–¢
else if finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–º (% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞)
posVol = calculatePositionVolume(close)

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
if posVol > 0 and checkSufficientFunds(posVol, close)
// –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ü–û –†–´–ù–ö–£ (–º–∞—Ä–∫–µ—Ç)
shortEntryPrice := close
shortPositionActive := true
shortAvgCount := 0
shortTotalVolume := posVol
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–¥–µ–ª–∫–∏
strategy.entry("SHORT", strategy.short, qty=posVol)

// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –ü–û–°–õ–ï –æ—Ç–∫—Ä—ã—Ç–∏—è
shortStopLossPrice := useSL ? close * (1 + slPercent / 100) : na
shortTakeProfitPrice := useTP ? close * (1 - tpPercent / 100) : na

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
array.fill(shortAvgPrices, na)
array.fill(shortAvgVolumes, 0.0)
array.set(shortAvgPrices, 0, shortEntryPrice)
array.set(shortAvgVolumes, 0, posVol)

// –õ–û–ì–ò–ö–ê –£–°–†–ï–î–ù–ï–ù–ò–Ø (–¢–û–õ–¨–ö–û –í –°–¢–û–†–û–ù–£ –£–ë–´–¢–ö–ê)
if longPositionActive and useAveraging and longAvgCount < maxAvgCount
avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
if not na(avgPrice) and close < avgPrice // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–π
nextAvgPrice = avgPrice * (1 - avgDistancePercent / 100)
if close <= nextAvgPrice
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–º –ø–æ –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª—É (–æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞)
newVol = longTotalVolume * martingaleMultiplier

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
if checkSufficientFunds(newVol, close)
// –£—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
longAvgCount := longAvgCount + 1
array.set(longAvgPrices, longAvgCount, close)
array.set(longAvgVolumes, longAvgCount, newVol)
longTotalVolume := longTotalVolume + newVol
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –¥–ª—è –∑–∞–ø–∏—Å–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
strategy.entry("LONG", strategy.long, qty=newVol)

// –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
newAvgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
longStopLossPrice := useSL ? newAvgPrice * (1 - slPercent / 100) : na
longTakeProfitPrice := useTP ? newAvgPrice * (1 + tpPercent / 100) : na

if shortPositionActive and useAveraging and shortAvgCount < maxAvgCount
avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
if not na(avgPrice) and close > avgPrice // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π
nextAvgPrice = avgPrice * (1 + avgDistancePercent / 100)
if close >= nextAvgPrice
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–º –ø–æ –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª—É (–æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞)
newVol = shortTotalVolume * martingaleMultiplier

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
if checkSufficientFunds(newVol, close)
// –£—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
shortAvgCount := shortAvgCount + 1
array.set(shortAvgPrices, shortAvgCount, close)
array.set(shortAvgVolumes, shortAvgCount, newVol)
shortTotalVolume := shortTotalVolume + newVol
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –¥–ª—è –∑–∞–ø–∏—Å–∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
strategy.entry("SHORT", strategy.short, qty=newVol)

// –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
newAvgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
shortStopLossPrice := useSL ? newAvgPrice * (1 + slPercent / 100) : na
shortTakeProfitPrice := useTP ? newAvgPrice * (1 - tpPercent / 100) : na

// –õ–û–ì–ò–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô
if longPositionActive
avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
if not na(avgPrice)
shouldClose = false
closeReason = ""

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç–∞
if useTP and close >= longTakeProfitPrice
shouldClose := true
closeReason := "TP"

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –°—Ç–æ–ø-–õ–æ—Å—Å–∞
else if useSL and close <= longStopLossPrice
shouldClose := true
closeReason := "SL"

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SL)
else if not useSL
liqPrice = calculateLiquidationPrice(avgPrice, true)
if close <= liqPrice
shouldClose := true
closeReason := "LIQ"

if shouldClose
// –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
profit = calculatePnL(avgPrice, close, longTotalVolume, true)
currentBalance := currentBalance + profit
totalProfit := totalProfit + profit
totalCommission := totalCommission + calculateCommission(longTotalVolume, close)

if profit >= 0
totalWins := totalWins + 1
else
totalLosses := totalLosses + 1

longPositionActive := false
longAvgCount := 0
// –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É
strategy.close("LONG", comment=closeReason)

if shortPositionActive
avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
if not na(avgPrice)
shouldClose = false
closeReason = ""

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç–∞
if useTP and close <= shortTakeProfitPrice
shouldClose := true
closeReason := "TP"

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –°—Ç–æ–ø-–õ–æ—Å—Å–∞
else if useSL and close >= shortStopLossPrice
shouldClose := true
closeReason := "SL"

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SL)
else if not useSL
liqPrice = calculateLiquidationPrice(avgPrice, false)
if close >= liqPrice
shouldClose := true
closeReason := "LIQ"

if shouldClose
// –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
profit = calculatePnL(avgPrice, close, shortTotalVolume, false)
currentBalance := currentBalance + profit
totalProfit := totalProfit + profit
totalCommission := totalCommission + calculateCommission(shortTotalVolume, close)

if profit >= 0
totalWins := totalWins + 1
else
totalLosses := totalLosses + 1

shortPositionActive := false
shortAvgCount := 0
// –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ä–¥–µ—Ä –≤ Strategy Tester –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É
strategy.close("SHORT", comment=closeReason)



// --- 30_–û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï_–ù–ê_–ì–†–ê–§–ò–ö–ï.pine ---
// ============================================
// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê –ì–†–ê–§–ò–ö–ï


// --- 31_–û—Ç–æ–±—Ä–∞–∂–∞–µ–º_—Å–∏–≥–Ω–∞–ª—ã_–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ_–æ—Ç_–Ω–∞—Å—Ç—Ä–æ–π–∫–∏_–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.pine ---
// ============================================
// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
plotshape(showLongSignal and tradingEnabled and not anyPositionActive and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥") and isInTimePeriod(), "Long Signal", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(showShortSignal and tradingEnabled and not anyPositionActive and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç") and isInTimePeriod(), "Short Signal", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

plot(bbUpper, "BB Upper", color=color.blue, linewidth=1, display = useBB ? display.all : display.none)
plot(bbBasis, "BB Basis", color=color.orange, linewidth=1, display = useBB ? display.all : display.none)
plot(bbLower, "BB Lower", color=color.blue, linewidth=1, display = useBB ? display.all : display.none)

if showDashboard
if longPositionActive
avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
if not na(avgPrice)
line.new(bar_index-10, avgPrice, bar_index, avgPrice, color=color.new(color.green, 50), width=2, style=line.style_solid)

if useTP and not na(longTakeProfitPrice)
line.new(bar_index-10, longTakeProfitPrice, bar_index, longTakeProfitPrice, color=color.new(color.green, 70), width=1, style=line.style_dashed)

if useSL and not na(longStopLossPrice)
line.new(bar_index-10, longStopLossPrice, bar_index, longStopLossPrice, color=color.new(color.red, 70), width=1, style=line.style_dashed)

if useAveraging and longAvgCount < maxAvgCount
nextAvgPrice = avgPrice * (1 - avgDistancePercent / 100)
line.new(bar_index-10, nextAvgPrice, bar_index, nextAvgPrice, color=color.new(color.orange, 50), width=1, style=line.style_dotted)

if shortPositionActive
avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
if not na(avgPrice)
line.new(bar_index-10, avgPrice, bar_index, avgPrice, color=color.new(color.red, 50), width=2, style=line.style_solid)

if useTP and not na(shortTakeProfitPrice)
line.new(bar_index-10, shortTakeProfitPrice, bar_index, shortTakeProfitPrice, color=color.new(color.green, 70), width=1, style=line.style_dashed)

if useSL and not na(shortStopLossPrice)
line.new(bar_index-10, shortStopLossPrice, bar_index, shortStopLossPrice, color=color.new(color.red, 70), width=1, style=line.style_dashed)

if useAveraging and shortAvgCount < maxAvgCount
nextAvgPrice = avgPrice * (1 + avgDistancePercent / 100)
line.new(bar_index-10, nextAvgPrice, bar_index, nextAvgPrice, color=color.new(color.orange, 50), width=1, style=line.style_dotted)



// --- 32_–û–ë–ù–û–í–õ–ï–ù–ò–ï_–î–ê–®–ë–û–†–î–ê.pine ---
// ============================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê


// --- 33_section_33.pine ---
// ============================================
if barstate.islast
drawDashboard()



// --- 34_–ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø_–ú–ï–¢–ö–ê.pine ---
// ============================================
// –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –ú–ï–¢–ö–ê


// --- 35_section_35.pine ---
// ============================================
if barstate.islast
balanceChange = ((currentBalance - initialDeposit) / initialDeposit) * 100
winRateValue = totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥
infoStartDateStr = useCustomStartDate ? formatDate(startDate) : "–ù–ê–ß–ê–õ–û –ì–†–ê–§–ò–ö–ê"
infoEndDateStr = useRealTimeEnd ? "–ò–î–ï–¢ –¢–û–†–ì–û–í–õ–Ø" : formatDate(endDate)
infoText = "üéõÔ∏è –ë–ï–ö–¢–ï–°–¢ –î–õ–Ø –°–¢–†–ê–¢–ï–ì–ò–ô v3.7 | –ü–µ—Ä–∏–æ–¥: " + infoStartDateStr + " - " + infoEndDateStr + " | –ë–∞–ª–∞–Ω—Å: $" + str.tostring(currentBalance, "#.##") + " (" + str.tostring(balanceChange, "#.##") + "%) | Win Rate: " + str.tostring(winRateValue, "#.##") + "% | –°–¥–µ–ª–æ–∫: " + str.tostring(totalWins + totalLosses)
label.new(bar_index, high * 1.02, infoText, color=color.new(#1A237E, 90), textcolor=color.white, style=label.style_label_center, size=size.normal)


