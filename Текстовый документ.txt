//@version=5
indicator("–£–º–Ω—ã–π –ë–æ—Ç –î–∞—à–±–æ—Ä–¥ Pro v3.3", overlay=true, max_labels_count=500, max_lines_count=500, max_bars_back=5000)

// ============================================
// –ì–†–£–ü–ü–ê 1: –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò
// ============================================
showDashboard = input.bool(true, "üìä –ü–æ–∫–∞–∑–∞—Ç—å –î–∞—à–±–æ—Ä–¥", group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
dashboardPosition = input.string("Top Right", "–ü–æ–∑–∏—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞", options=["Top Left", "Top Center", "Top Right", "Bottom Left", "Bottom Center", "Bottom Right"], group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
dashboardColumns = input.int(3, "–ö–æ–ª–æ–Ω–æ–∫ –≤ –¥–∞—à–±–æ—Ä–¥–µ", minval=2, maxval=4, group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
botMode = input.string("–û–±–∞", "–†–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏", options=["–û–±–∞", "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥", "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç"], group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")

initialDeposit = input.float(1000, "–ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç ($)", minval=100, maxval=100000, step=100, group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
commission = input.float(0.1, "–ö–æ–º–∏—Å—Å–∏—è (%)", minval=0.01, maxval=1, step=0.01, group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
marginType = input.string("–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–¢–∏–ø –º–∞—Ä–∂–∏", options=["–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è", "–ö—Ä–æ—Å—Å"], group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")
leverage = input.int(10, "–ü–ª–µ—á–æ (1-100)", minval=1, maxval=100, group="üéõÔ∏è –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò")

// ============================================
// –ì–†–£–ü–ü–ê 2: –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú
// ============================================
riskPerTrade = input.float(2.0, "–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%)", minval=0.1, maxval=10, step=0.1, group="üéØ –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")
volumeMethod = input.string("–ü–æ —Ä–∏—Å–∫—É", "–ú–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –æ–±—ä–µ–º–∞", options=["–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", "% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞", "–ü–æ —Ä–∏—Å–∫—É"], group="üéØ –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ò–°–ö–û–ú")

// ============================================
// –ì–†–£–ü–ü–ê 3: –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í
// ============================================
useTP = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")
tpPercent = input.float(1.5, "–¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç %", minval=0.1, maxval=20, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")

useSL = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å –°—Ç–æ–ø-–õ–æ—Å—Å", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")
slPercent = input.float(1.0, "–°—Ç–æ–ø-–õ–æ—Å—Å %", minval=0.1, maxval=20, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")

usePendingOrders = input.bool(true, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –û–†–î–ï–†–û–í")

// ============================================
// –ì–†–£–ü–ü–ê 4: –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø
// ============================================
useAveraging = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ", group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
maxAvgCount = input.int(5, "–ú–∞–∫—Å. —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–π (1-10)", minval=1, maxval=10, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
martingaleMultiplier = input.float(2.0, "–ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—ä–µ–º–∞", minval=1.0, maxval=3.0, step=0.1, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")
avgDistancePercent = input.float(0.5, "–î–∏—Å—Ç–∞–Ω—Ü–∏—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è %", minval=0.1, maxval=5.0, step=0.1, group="üìà –ù–ê–°–¢–†–û–ô–ö–ò –£–°–†–ï–î–ù–ï–ù–ò–Ø")

// ============================================
// –ì–†–£–ü–ü–ê 5: –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í
// ============================================
useRSI = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å RSI", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiLength = input.int(14, "–ü–µ—Ä–∏–æ–¥ RSI (7-30)", minval=7, maxval=30, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiLongLevel = input.int(30, "–£—Ä–æ–≤–µ–Ω—å –ø–æ–∫—É–ø–∫–∏ RSI", minval=1, maxval=50, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
rsiShortLevel = input.int(70, "–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–¥–∞–∂–∏ RSI", minval=50, maxval=99, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")

useBB = input.bool(true, "‚úÖ –í–∫–ª—é—á–∏—Ç—å Bollinger Bands", group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
bbLength = input.int(20, "–ü–µ—Ä–∏–æ–¥ BB (10-50)", minval=10, maxval=50, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")
bbStdDev = input.float(2.0, "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ", minval=1.5, maxval=3.0, step=0.1, group="üìä –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–î–ò–ö–ê–¢–û–†–û–í")

// ============================================
// –†–ê–°–ß–ï–¢ –ò–ù–î–ò–ö–ê–¢–û–†–û–í
// ============================================
rsi = ta.rsi(close, rsiLength)
bbBasis = ta.sma(close, bbLength)
bbDev = bbStdDev * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// ============================================
// –°–ò–ì–ù–ê–õ–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê)
// ============================================
// –°–∏–≥–Ω–∞–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
rsiLongSignal = useRSI and rsi <= rsiLongLevel
rsiShortSignal = useRSI and rsi >= rsiShortLevel
bbLongSignal = useBB and close <= bbLower
bbShortSignal = useBB and close >= bbUpper

// –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (—Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
finalLongSignal = false
finalShortSignal = false

if useRSI and useBB
    // –ï—Å–ª–∏ –æ–±–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω—ã - –Ω—É–∂–Ω—ã —Å–∏–≥–Ω–∞–ª—ã –æ—Ç –æ–±–æ–∏—Ö
    finalLongSignal := rsiLongSignal and bbLongSignal
    finalShortSignal := rsiShortSignal and bbShortSignal
else if useRSI
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç–æ–ª—å–∫–æ RSI
    finalLongSignal := rsiLongSignal
    finalShortSignal := rsiShortSignal
else if useBB
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ç–æ–ª—å–∫–æ BB
    finalLongSignal := bbLongSignal
    finalShortSignal := bbShortSignal

// –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ (—Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
showLongSignal = rsiLongSignal or bbLongSignal
showShortSignal = rsiShortSignal or bbShortSignal

// ============================================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ============================================
var float currentBalance = initialDeposit
var float maxBalance = initialDeposit
var float maxDrawdownValue = 0.0
var bool tradingEnabled = true
var bool botStopped = false

var float longEntryPrice = na
var float shortEntryPrice = na
var int longAvgCount = 0
var int shortAvgCount = 0
var float longTotalVolume = 0.0
var float shortTotalVolume = 0.0
var bool longPositionActive = false
var bool shortPositionActive = false
var bool anyPositionActive = false

var int totalWins = 0
var int totalLosses = 0
var float totalProfit = 0.0
var float totalCommission = 0.0

var array<float> longAvgPrices = array.new<float>(10, na)
var array<float> shortAvgPrices = array.new<float>(10, na)
var array<float> longAvgVolumes = array.new<float>(10, 0.0)
var array<float> shortAvgVolumes = array.new<float>(10, 0.0)

var float longStopLossPrice = na
var float longTakeProfitPrice = na
var float shortStopLossPrice = na
var float shortTakeProfitPrice = na

// ============================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)
// ============================================

calculateAveragePrice(prices, volumes) =>
    totalValue = 0.0
    totalVolume = 0.0
    for i = 0 to array.size(prices) - 1
        price = array.get(prices, i)
        volume = array.get(volumes, i)
        if not na(price)
            totalValue := totalValue + price * volume
            totalVolume := totalVolume + volume
    totalVolume > 0 ? totalValue / totalVolume : na

calculatePositionVolume(entryPrice, stopLossPrice, isLong) =>
    float volume = 0.0
    
    if volumeMethod == "–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"
        volume := (initialDeposit * 0.02) / entryPrice
    
    else if volumeMethod == "% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞"
        volume := (currentBalance * (riskPerTrade / 100)) / entryPrice
    
    else if volumeMethod == "–ü–æ —Ä–∏—Å–∫—É"
        riskAmount = currentBalance * (riskPerTrade / 100)
        priceDifference = math.abs(entryPrice - stopLossPrice)
        if priceDifference > 0
            volume := riskAmount / priceDifference
        else
            volume := 0
    
    maxVolume = (currentBalance * leverage) / entryPrice
    volume := math.min(volume, maxVolume)
    volume

calculateCommission(volume, price) =>
    (volume * price) * (commission / 100)

calculateLiquidationPrice(entryPrice, isLong) =>
    if marginType == "–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è"
        if isLong
            entryPrice * (1 - (1 / leverage) * 0.9)
        else
            entryPrice * (1 + (1 / leverage) * 0.9)
    else
        if isLong
            entryPrice * (1 - (1 / leverage) * 0.8)
        else
            entryPrice * (1 + (1 / leverage) * 0.8)

checkSufficientFunds(volume, price) =>
    requiredMargin = (volume * price) / leverage
    freeMargin = currentBalance - (longTotalVolume * (longPositionActive ? longEntryPrice : 0) + shortTotalVolume * (shortPositionActive ? shortEntryPrice : 0)) / leverage
    requiredMargin <= freeMargin

calculatePnL(entryPrice, exitPrice, volume, isLong) =>
    float profit = 0.0
    if isLong
        profit := (exitPrice - entryPrice) * volume
    else
        profit := (entryPrice - exitPrice) * volume
    
    commissionFee = calculateCommission(volume, exitPrice)
    profit - commissionFee

// ============================================
// –û–¢–†–ò–°–û–í–ö–ê –î–ê–®–ë–û–†–î–ê
// ============================================
drawDashboard() =>
    if barstate.islast and showDashboard
        tablePos = switch dashboardPosition
            "Top Left" => position.top_left
            "Top Center" => position.top_center
            "Top Right" => position.top_right
            "Bottom Left" => position.bottom_left
            "Bottom Center" => position.bottom_center
            "Bottom Right" => position.bottom_right
            => position.top_right
        
        dash = table.new(tablePos, dashboardColumns, 26, bgcolor = color.new(#000000, 80), border_color = color.new(#555555, 50))
        
        row = 0
        
        // –ó–ê–ì–û–õ–û–í–û–ö
        table.cell(dash, 0, row, "‚ö° –£–ú–ù–´–ô –ë–û–¢ v3.3 ‚ö°", bgcolor = color.new(#4A148C, 90), text_color = color.white, text_size = size.normal)
        if dashboardColumns >= 2
            table.cell(dash, 1, row, "–ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô", bgcolor = color.new(#4A148C, 90), text_color = color.yellow, text_size = size.small)
        if dashboardColumns >= 3
            table.cell(dash, 2, row, timeframe.period, bgcolor = color.new(#4A148C, 90), text_color = color.white, text_size = size.small)
        
        row := row + 1
        
        // –ö–ê–ü–ò–¢–ê–õ –ò –ë–ê–õ–ê–ù–°
        table.cell(dash, 0, row, "üí∞ –ö–ê–ü–ò–¢–ê–õ", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "–ù–∞—á–∞–ª—å–Ω—ã–π:", text_color = color.gray)
        table.cell(dash, 2, row, "$" + str.tostring(initialDeposit, "#.##"), text_color = color.white)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–¢–µ–∫—É—â–∏–π:", text_color = color.gray)
        balanceColor = currentBalance >= initialDeposit ? color.green : color.red
        table.cell(dash, 2, row, "$" + str.tostring(currentBalance, "#.##"), text_color = balanceColor)
        
        row := row + 1
        
        profitPercent = ((currentBalance - initialDeposit) / initialDeposit) * 100
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–ü—Ä–∏–±—ã–ª—å:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(profitPercent, "#.##") + "%", text_color = profitPercent >= 0 ? color.green : color.red)
        
        row := row + 1
        
        // –†–ò–°–ö
        table.cell(dash, 0, row, "üìä –†–ò–°–ö", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "–†–∏—Å–∫/—Å–¥–µ–ª–∫—É:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(riskPerTrade, "#.#") + "%", text_color = color.yellow)
        
        row := row + 1
        
        // –°–¢–ê–¢–£–° –¢–û–†–ì–û–í–õ–ò
        table.cell(dash, 0, row, "‚ö° –°–¢–ê–¢–£–°", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "–ë–æ—Ç:", text_color = color.gray)
        statusText = botStopped ? "–û–°–¢–ê–ù–û–í–õ–ï–ù" : tradingEnabled ? "–ê–ö–¢–ò–í–ï–ù" : "–ü–ê–£–ó–ê"
        statusColor = botStopped ? color.red : tradingEnabled ? color.green : color.orange
        table.cell(dash, 2, row, statusText, text_color = statusColor)
        
        row := row + 1
        
        // –†–ï–ñ–ò–ú –ò –ú–ê–†–ñ–ê
        table.cell(dash, 0, row, "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "–†–µ–∂–∏–º:", text_color = color.gray)
        botColor = botMode == "–û–±–∞" ? color.orange : botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥" ? color.green : color.red
        table.cell(dash, 2, row, botMode, text_color = botColor)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–ú–∞—Ä–∂–∞:", text_color = color.gray)
        table.cell(dash, 2, row, marginType, text_color = color.blue)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–ü–ª–µ—á–æ:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(leverage) + "x", text_color = color.yellow)
        
        row := row + 1
        
        // –ò–ù–î–ò–ö–ê–¢–û–†–´
        table.cell(dash, 0, row, "üìä –ò–ù–î–ò–ö–ê–¢–û–†–´", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "RSI:", text_color = color.gray)
        rsiColor = rsi <= 30 ? color.green : rsi >= 70 ? color.red : color.white
        table.cell(dash, 2, row, str.tostring(rsi, "#.##"), text_color = rsiColor)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "BB:", text_color = color.gray)
        bbPos = close <= bbLower ? "–ù–ò–ó" : close >= bbUpper ? "–í–ï–†–•" : "–°–†–ï–î"
        bbPosColor = close <= bbLower ? color.green : close >= bbUpper ? color.red : color.gray
        table.cell(dash, 2, row, bbPos, text_color = bbPosColor)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–¶–µ–Ω–∞:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(close, "#.#####"), text_color = color.white)
        
        row := row + 1
        
        // –ê–ö–¢–ò–í–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø
        table.cell(dash, 0, row, "üìà –ü–û–ó–ò–¶–ò–Ø", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        if longPositionActive
            table.cell(dash, 1, row, "–õ–û–ù–ì", bgcolor = color.new(#1B5E20, 70), text_color = color.white)
        else if shortPositionActive
            table.cell(dash, 1, row, "–®–û–†–¢", bgcolor = color.new(#B71C1C, 70), text_color = color.white)
        else
            table.cell(dash, 1, row, "–ù–ï–¢", bgcolor = color.new(#424242, 70), text_color = color.white)
        
        if dashboardColumns >= 3
            if longPositionActive or shortPositionActive
                table.cell(dash, 2, row, "–ê–ö–¢–ò–í–ù–ê", text_color = color.green)
            else
                table.cell(dash, 2, row, "–û–ñ–ò–î–ê–ù–ò–ï", text_color = color.gray)
        
        row := row + 1
        
        if longPositionActive
            avgPriceLong = calculateAveragePrice(longAvgPrices, longAvgVolumes)
            table.cell(dash, 0, row, "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:", text_color = color.gray)
            table.cell(dash, 1, row, str.tostring(avgPriceLong, "#.#####"), text_color = color.green)
            
            if dashboardColumns >= 3
                currentPLLong = not na(avgPriceLong) ? ((close - avgPriceLong) / avgPriceLong) * 100 : 0
                table.cell(dash, 2, row, str.tostring(currentPLLong, "#.##") + "%", text_color = currentPLLong >= 0 ? color.green : color.red)
            
        else if shortPositionActive
            avgPriceShort = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
            table.cell(dash, 0, row, "–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:", text_color = color.gray)
            table.cell(dash, 1, row, str.tostring(avgPriceShort, "#.#####"), text_color = color.red)
            
            if dashboardColumns >= 3
                currentPLShort = not na(avgPriceShort) ? ((avgPriceShort - close) / avgPriceShort) * 100 : 0
                table.cell(dash, 2, row, str.tostring(currentPLShort, "#.##") + "%", text_color = currentPLShort >= 0 ? color.green : color.red)
            
        else
            table.cell(dash, 0, row, "–°—Ç–∞—Ç—É—Å:", text_color = color.gray)
            table.cell(dash, 1, row, "–û–∂–∏–¥–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞", text_color = color.white)
            if dashboardColumns >= 3
                table.cell(dash, 2, row, "", text_color = color.gray)
        
        row := row + 1
        
        // –£–°–†–ï–î–ù–ï–ù–ò–Ø
        if longPositionActive or shortPositionActive
            table.cell(dash, 0, row, "–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–π:", text_color = color.gray)
            if longPositionActive
                table.cell(dash, 1, row, str.tostring(longAvgCount), text_color = longAvgCount > 0 ? color.orange : color.gray)
            else
                table.cell(dash, 1, row, str.tostring(shortAvgCount), text_color = shortAvgCount > 0 ? color.orange : color.gray)
            
            if dashboardColumns >= 3
                table.cell(dash, 2, row, "", text_color = color.gray)
            
            row := row + 1
        
        // –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–î–ï–õ–û–ö
        table.cell(dash, 0, row, "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "–ü–æ–±–µ–¥:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(totalWins), text_color = color.green)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–ü–æ—Ä–∞–∂–µ–Ω–∏–π:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(totalLosses), text_color = color.red)
        
        row := row + 1
        
        winRate = totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–í–∏–Ω—Ä–µ–π—Ç:", text_color = color.gray)
        table.cell(dash, 2, row, str.tostring(winRate, "#.##") + "%", text_color = winRate >= 50 ? color.green : color.red)
        
        row := row + 1
        
        // –û–ë–©–ê–Ø –ü–†–ò–ë–´–õ–¨
        table.cell(dash, 0, row, "üí∞ –ü–†–ò–ë–´–õ–¨", bgcolor = color.new(#4A148C, 80), text_color = color.white)
        table.cell(dash, 1, row, "–í—Å–µ–≥–æ:", text_color = color.gray)
        table.cell(dash, 2, row, "$" + str.tostring(totalProfit, "#.##"), text_color = totalProfit >= 0 ? color.green : color.red)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "–ö–æ–º–∏—Å—Å–∏–∏:", text_color = color.gray)
        table.cell(dash, 2, row, "$" + str.tostring(totalCommission, "#.##"), text_color = color.orange)
        
        row := row + 1
        
        // –°–ò–ì–ù–ê–õ–´
        table.cell(dash, 0, row, "üéØ –°–ò–ì–ù–ê–õ–´", bgcolor = color.new(#1A237E, 70), text_color = color.white)
        table.cell(dash, 1, row, "RSI:", text_color = color.gray)
        rsiSignal = rsiLongSignal or rsiShortSignal
        table.cell(dash, 2, row, rsiSignal ? "–î–ê" : "–ù–ï–¢", text_color = rsiSignal ? color.green : color.red)
        
        row := row + 1
        
        table.cell(dash, 0, row, "", text_color = color.gray)
        table.cell(dash, 1, row, "BB:", text_color = color.gray)
        bbSignal = bbLongSignal or bbShortSignal
        table.cell(dash, 2, row, bbSignal ? "–î–ê" : "–ù–ï–¢", text_color = bbSignal ? color.green : color.red)
        
        row := row + 1
        
        // –¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ
        canTrade = tradingEnabled and not anyPositionActive and not botStopped
        
        signalBg = color.new(#424242, 80)
        if canTrade and finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
            signalBg := color.new(#1B5E20, 80)
        else if canTrade and finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
            signalBg := color.new(#B71C1C, 80)
        
        table.cell(dash, 0, row, "üéØ –¢–ï–ö–£–©–ò–ô –°–ò–ì–ù–ê–õ", bgcolor = signalBg, text_color = color.white)
        
        signalText = ""
        if botStopped
            signalText := "–ë–û–¢ –û–°–¢–ê–ù–û–í–õ–ï–ù"
        else if tradingEnabled == false
            signalText := "–¢–û–†–ì–û–í–õ–Ø –ü–†–ò–û–°–¢–ê–ù–û–í–õ–ï–ù–ê"
        else if anyPositionActive
            signalText := "–ü–û–ó–ò–¶–ò–Ø –û–¢–ö–†–´–¢–ê"
        else if finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
            signalText := "–õ–û–ù–ì üü¢"
        else if finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
            signalText := "–®–û–†–¢ üî¥"
        else
            signalText := "–û–ñ–ò–î–ê–ù–ò–ï ‚ö™"
        
        signalColor = color.gray
        if signalText == "–õ–û–ù–ì üü¢"
            signalColor := color.green
        else if signalText == "–®–û–†–¢ üî¥"
            signalColor := color.red
        
        if dashboardColumns >= 2
            table.cell(dash, 1, row, signalText, text_color = signalColor, text_size = size.normal)

// ============================================
// –û–°–ù–û–í–ù–ê–Ø –¢–û–†–ì–û–í–ê–Ø –õ–û–ì–ò–ö–ê
// ============================================
if barstate.isconfirmed and not botStopped
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    anyPositionActive := longPositionActive or shortPositionActive
    
    // –û–ë–ù–û–í–õ–Ø–ï–ú –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ë–ê–õ–ê–ù–° –ò –ü–†–û–°–ê–î–ö–£
    if currentBalance > maxBalance
        maxBalance := currentBalance
    
    drawdown = ((maxBalance - currentBalance) / maxBalance) * 100
    maxDrawdownValue := math.max(maxDrawdownValue, drawdown)
    
    // –õ–û–ì–ò–ö–ê –û–¢–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô
    if tradingEnabled and not anyPositionActive
        // –ü–†–û–í–ï–†–ö–ê –°–ò–ì–ù–ê–õ–ê –ù–ê –õ–û–ù–ì
        if finalLongSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥")
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å
            slPrice = useSL ? close * (1 - slPercent / 100) : calculateLiquidationPrice(close, true)
            tpPrice = useTP ? close * (1 + tpPercent / 100) : na
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–º
            volume = calculatePositionVolume(close, slPrice, true)
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
            if volume > 0 and checkSufficientFunds(volume, close)
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
                longEntryPrice := close
                longPositionActive := true
                longAvgCount := 0
                longTotalVolume := volume
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã –æ—Ä–¥–µ—Ä–æ–≤
                longStopLossPrice := slPrice
                longTakeProfitPrice := tpPrice
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
                array.fill(longAvgPrices, na)
                array.fill(longAvgVolumes, 0.0)
                array.set(longAvgPrices, 0, longEntryPrice)
                array.set(longAvgVolumes, 0, volume)
        
        // –ü–†–û–í–ï–†–ö–ê –°–ò–ì–ù–ê–õ–ê –ù–ê –®–û–†–¢
        else if finalShortSignal and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç")
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å
            slPrice = useSL ? close * (1 + slPercent / 100) : calculateLiquidationPrice(close, false)
            tpPrice = useTP ? close * (1 - tpPercent / 100) : na
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–º
            volume = calculatePositionVolume(close, slPrice, false)
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
            if volume > 0 and checkSufficientFunds(volume, close)
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
                shortEntryPrice := close
                shortPositionActive := true
                shortAvgCount := 0
                shortTotalVolume := volume
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã –æ—Ä–¥–µ—Ä–æ–≤
                shortStopLossPrice := slPrice
                shortTakeProfitPrice := tpPrice
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
                array.fill(shortAvgPrices, na)
                array.fill(shortAvgVolumes, 0.0)
                array.set(shortAvgPrices, 0, shortEntryPrice)
                array.set(shortAvgVolumes, 0, volume)
    
    // –õ–û–ì–ò–ö–ê –£–°–†–ï–î–ù–ï–ù–ò–Ø (–¢–û–õ–¨–ö–û –í –°–¢–û–†–û–ù–£ –£–ë–´–¢–ö–ê)
    if longPositionActive and useAveraging and longAvgCount < maxAvgCount
        avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
        if not na(avgPrice) and close < avgPrice  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–π
            nextAvgPrice = avgPrice * (1 - avgDistancePercent / 100)
            if close <= nextAvgPrice
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–º –ø–æ –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª—É
                newVolume = longTotalVolume * martingaleMultiplier
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
                if checkSufficientFunds(newVolume, close)
                    // –£—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                    longAvgCount := longAvgCount + 1
                    array.set(longAvgPrices, longAvgCount, close)
                    array.set(longAvgVolumes, longAvgCount, newVolume)
                    longTotalVolume := longTotalVolume + newVolume
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
                    newAvgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
                    longStopLossPrice := useSL ? newAvgPrice * (1 - slPercent / 100) : calculateLiquidationPrice(newAvgPrice, true)
                    longTakeProfitPrice := useTP ? newAvgPrice * (1 + tpPercent / 100) : na
    
    if shortPositionActive and useAveraging and shortAvgCount < maxAvgCount
        avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
        if not na(avgPrice) and close > avgPrice  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π
            nextAvgPrice = avgPrice * (1 + avgDistancePercent / 100)
            if close >= nextAvgPrice
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–º –ø–æ –º–∞—Ä—Ç–∏–Ω–≥–µ–π–ª—É
                newVolume = shortTotalVolume * martingaleMultiplier
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
                if checkSufficientFunds(newVolume, close)
                    // –£—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                    shortAvgCount := shortAvgCount + 1
                    array.set(shortAvgPrices, shortAvgCount, close)
                    array.set(shortAvgVolumes, shortAvgCount, newVolume)
                    shortTotalVolume := shortTotalVolume + newVolume
                    
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –¥–ª—è –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
                    newAvgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
                    shortStopLossPrice := useSL ? newAvgPrice * (1 + slPercent / 100) : calculateLiquidationPrice(newAvgPrice, false)
                    shortTakeProfitPrice := useTP ? newAvgPrice * (1 - tpPercent / 100) : na
    
    // –õ–û–ì–ò–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ü–û–ó–ò–¶–ò–ô
    if longPositionActive
        avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
        if not na(avgPrice)
            shouldClose = false
            closeReason = ""
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç–∞
            if useTP and close >= longTakeProfitPrice
                shouldClose := true
                closeReason := "TP"
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –°—Ç–æ–ø-–õ–æ—Å—Å–∞
            else if useSL and close <= longStopLossPrice
                shouldClose := true
                closeReason := "SL"
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SL)
            else if not useSL
                liqPrice = calculateLiquidationPrice(avgPrice, true)
                if close <= liqPrice
                    shouldClose := true
                    closeReason := "LIQ"
            
            if shouldClose
                profit = calculatePnL(avgPrice, close, longTotalVolume, true)
                currentBalance := currentBalance + profit
                totalProfit := totalProfit + profit
                totalCommission := totalCommission + calculateCommission(longTotalVolume, close)
                
                if profit >= 0
                    totalWins := totalWins + 1
                else
                    totalLosses := totalLosses + 1
                
                longPositionActive := false
                longAvgCount := 0
    
    if shortPositionActive
        avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
        if not na(avgPrice)
            shouldClose = false
            closeReason = ""
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–µ–π–∫-–ü—Ä–æ—Ñ–∏—Ç–∞
            if useTP and close <= shortTakeProfitPrice
                shouldClose := true
                closeReason := "TP"
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –°—Ç–æ–ø-–õ–æ—Å—Å–∞
            else if useSL and close >= shortStopLossPrice
                shouldClose := true
                closeReason := "SL"
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º SL)
            else if not useSL
                liqPrice = calculateLiquidationPrice(avgPrice, false)
                if close >= liqPrice
                    shouldClose := true
                    closeReason := "LIQ"
            
            if shouldClose
                profit = calculatePnL(avgPrice, close, shortTotalVolume, false)
                currentBalance := currentBalance + profit
                totalProfit := totalProfit + profit
                totalCommission := totalCommission + calculateCommission(shortTotalVolume, close)
                
                if profit >= 0
                    totalWins := totalWins + 1
                else
                    totalLosses := totalLosses + 1
                
                shortPositionActive := false
                shortAvgCount := 0

// ============================================
// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê –ì–†–ê–§–ò–ö–ï
// ============================================
// –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
plotshape(showLongSignal and tradingEnabled and not anyPositionActive and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –õ–æ–Ω–≥"), "Long Signal", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(showShortSignal and tradingEnabled and not anyPositionActive and (botMode == "–û–±–∞" or botMode == "–¢–æ–ª—å–∫–æ –®–æ—Ä—Ç"), "Short Signal", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

plot(bbUpper, "BB Upper", color=color.blue, linewidth=1, display = useBB ? display.all : display.none)
plot(bbBasis, "BB Basis", color=color.orange, linewidth=1, display = useBB ? display.all : display.none)
plot(bbLower, "BB Lower", color=color.blue, linewidth=1, display = useBB ? display.all : display.none)

if showDashboard
    if longPositionActive
        avgPrice = calculateAveragePrice(longAvgPrices, longAvgVolumes)
        if not na(avgPrice)
            line.new(bar_index-10, avgPrice, bar_index, avgPrice, color=color.new(color.green, 50), width=2, style=line.style_solid)
            
            if useTP and not na(longTakeProfitPrice)
                line.new(bar_index-10, longTakeProfitPrice, bar_index, longTakeProfitPrice, color=color.new(color.green, 70), width=1, style=line.style_dashed)
            
            if useSL and not na(longStopLossPrice)
                line.new(bar_index-10, longStopLossPrice, bar_index, longStopLossPrice, color=color.new(color.red, 70), width=1, style=line.style_dashed)
            
            if useAveraging and longAvgCount < maxAvgCount
                nextAvgPrice = avgPrice * (1 - avgDistancePercent / 100)
                line.new(bar_index-10, nextAvgPrice, bar_index, nextAvgPrice, color=color.new(color.orange, 50), width=1, style=line.style_dotted)
    
    if shortPositionActive
        avgPrice = calculateAveragePrice(shortAvgPrices, shortAvgVolumes)
        if not na(avgPrice)
            line.new(bar_index-10, avgPrice, bar_index, avgPrice, color=color.new(color.red, 50), width=2, style=line.style_solid)
            
            if useTP and not na(shortTakeProfitPrice)
                line.new(bar_index-10, shortTakeProfitPrice, bar_index, shortTakeProfitPrice, color=color.new(color.green, 70), width=1, style=line.style_dashed)
            
            if useSL and not na(shortStopLossPrice)
                line.new(bar_index-10, shortStopLossPrice, bar_index, shortStopLossPrice, color=color.new(color.red, 70), width=1, style=line.style_dashed)
            
            if useAveraging and shortAvgCount < maxAvgCount
                nextAvgPrice = avgPrice * (1 + avgDistancePercent / 100)
                line.new(bar_index-10, nextAvgPrice, bar_index, nextAvgPrice, color=color.new(color.orange, 50), width=1, style=line.style_dotted)

// ============================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–®–ë–û–†–î–ê
// ============================================
if barstate.islast
    drawDashboard()

// ============================================
// –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –ú–ï–¢–ö–ê
// ============================================
if barstate.islast
    balanceChange = ((currentBalance - initialDeposit) / initialDeposit) * 100
    winRateValue = totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0
    infoText = "–£–º–Ω—ã–π –ë–æ—Ç Pro v3.3 | –ë–∞–ª–∞–Ω—Å: $" + str.tostring(currentBalance, "#.##") + " (" + str.tostring(balanceChange, "#.##") + "%) | Win Rate: " + str.tostring(winRateValue, "#.##") + "% | –°–¥–µ–ª–æ–∫: " + str.tostring(totalWins + totalLosses)
    label.new(bar_index, high * 1.02, infoText, color=color.new(#1A237E, 90), textcolor=color.white, style=label.style_label_center, size=size.normal)
